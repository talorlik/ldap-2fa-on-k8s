<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LDAP 2FA Authentication Application">
    <title>LDAP 2FA Authentication</title>
    <link rel="stylesheet" href="/css/styles.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <!-- Top Navigation Bar (shown when logged in) -->
    <header id="top-bar" class="top-bar hidden">
        <div class="top-bar-content">
            <div class="top-bar-brand">
                <span class="brand-icon">ğŸ”</span>
                <span class="brand-text">LDAP 2FA</span>
            </div>
            <div class="top-bar-user">
                <button id="user-menu-btn" class="user-menu-btn">
                    <span id="user-display-name" class="user-name">User</span>
                    <span class="dropdown-arrow">â–¼</span>
                </button>
                <div id="user-dropdown" class="user-dropdown hidden">
                    <a href="#" id="menu-profile" class="dropdown-item">
                        <span class="dropdown-icon">ğŸ‘¤</span> Profile
                    </a>
                    <div id="admin-menu-items" class="hidden">
                        <hr class="dropdown-divider">
                        <a href="#" id="menu-admin-users" class="dropdown-item">
                            <span class="dropdown-icon">ğŸ‘¥</span> User Management
                        </a>
                        <a href="#" id="menu-admin-groups" class="dropdown-item">
                            <span class="dropdown-icon">ğŸ“</span> Group Management
                        </a>
                    </div>
                    <hr class="dropdown-divider">
                    <a href="#" id="menu-logout" class="dropdown-item">
                        <span class="dropdown-icon">ğŸšª</span> Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div id="main-container" class="container">
        <header id="auth-header">
            <h1>ğŸ” LDAP 2FA Authentication</h1>
            <p class="subtitle">Secure two-factor authentication for your LDAP account</p>
        </header>

        <!-- Tab Navigation (pre-login) -->
        <nav id="auth-tabs" class="tabs">
            <button class="tab-btn active" data-tab="login">Login</button>
            <button class="tab-btn" data-tab="signup">Sign Up</button>
            <button class="tab-btn" data-tab="enroll">Enroll MFA</button>
        </nav>

        <!-- Login Tab -->
        <section id="login-tab" class="tab-content active">
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" name="username" required
                           placeholder="Enter your username" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" name="password" required
                           placeholder="Enter your password" autocomplete="current-password">
                </div>

                <div class="form-group">
                    <label for="login-code">Verification Code</label>
                    <div class="code-input-group">
                        <input type="text" id="login-code" name="verification_code" required
                               placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}"
                               autocomplete="one-time-code" inputmode="numeric">
                        <button type="button" id="send-sms-btn" class="btn btn-secondary btn-small hidden">
                            Send SMS
                        </button>
                    </div>
                    <small id="sms-status" class="form-hint hidden"></small>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Login</span>
                    <span class="btn-loading hidden">Authenticating...</span>
                </button>
            </form>

            <div id="login-result" class="result-container hidden"></div>
        </section>

        <!-- Signup Tab -->
        <section id="signup-tab" class="tab-content">
            <form id="signup-form" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-firstname">First Name</label>
                        <input type="text" id="signup-firstname" name="first_name" required
                               placeholder="First name" autocomplete="given-name">
                    </div>
                    <div class="form-group">
                        <label for="signup-lastname">Last Name</label>
                        <input type="text" id="signup-lastname" name="last_name" required
                               placeholder="Last name" autocomplete="family-name">
                    </div>
                </div>

                <div class="form-group">
                    <label for="signup-username">Username</label>
                    <input type="text" id="signup-username" name="username" required
                           placeholder="Choose a username" autocomplete="username"
                           pattern="[a-zA-Z][a-zA-Z0-9_-]*" minlength="3" maxlength="64">
                    <small class="form-hint">Letters, numbers, underscores, and hyphens only</small>
                </div>

                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" name="email" required
                           placeholder="your@email.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="signup-phone">Phone Number</label>
                    <div class="phone-input-group">
                        <select id="signup-country-code" name="phone_country_code" required>
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                            <option value="+39">ğŸ‡®ğŸ‡¹ +39</option>
                            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
                            <option value="+31">ğŸ‡³ğŸ‡± +31</option>
                            <option value="+32">ğŸ‡§ğŸ‡ª +32</option>
                            <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                            <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                            <option value="+46">ğŸ‡¸ğŸ‡ª +46</option>
                            <option value="+47">ğŸ‡³ğŸ‡´ +47</option>
                            <option value="+45">ğŸ‡©ğŸ‡° +45</option>
                            <option value="+358">ğŸ‡«ğŸ‡® +358</option>
                            <option value="+48">ğŸ‡µğŸ‡± +48</option>
                            <option value="+351">ğŸ‡µğŸ‡¹ +351</option>
                            <option value="+353">ğŸ‡®ğŸ‡ª +353</option>
                            <option value="+972">ğŸ‡®ğŸ‡± +972</option>
                            <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                            <option value="+966">ğŸ‡¸ğŸ‡¦ +966</option>
                            <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                            <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                            <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                            <option value="+82">ğŸ‡°ğŸ‡· +82</option>
                            <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
                            <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
                            <option value="+64">ğŸ‡³ğŸ‡¿ +64</option>
                            <option value="+55">ğŸ‡§ğŸ‡· +55</option>
                            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
                            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
                            <option value="+27">ğŸ‡¿ğŸ‡¦ +27</option>
                            <option value="+234">ğŸ‡³ğŸ‡¬ +234</option>
                            <option value="+254">ğŸ‡°ğŸ‡ª +254</option>
                            <option value="+20">ğŸ‡ªğŸ‡¬ +20</option>
                        </select>
                        <input type="tel" id="signup-phone" name="phone_number" required
                               placeholder="Phone number" autocomplete="tel-national"
                               pattern="[0-9]{5,15}" minlength="5" maxlength="15">
                    </div>
                    <small class="form-hint">Enter your phone number without the country code</small>
                </div>

                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" name="password" required
                           placeholder="Create a password" autocomplete="new-password"
                           minlength="8">
                    <small class="form-hint">Minimum 8 characters</small>
                </div>

                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" name="confirm_password" required
                           placeholder="Confirm your password" autocomplete="new-password">
                </div>

                <!-- MFA Method Selection -->
                <div class="form-group">
                    <label>MFA Method</label>
                    <div class="mfa-method-selector">
                        <label class="radio-option">
                            <input type="radio" name="signup_mfa_method" value="totp" checked>
                            <span class="radio-label">
                                <span class="radio-icon">ğŸ“±</span>
                                <span class="radio-text">
                                    <strong>Authenticator App</strong>
                                    <small>Google Authenticator, Authy, etc.</small>
                                </span>
                            </span>
                        </label>
                        <label class="radio-option" id="signup-sms-option">
                            <input type="radio" name="signup_mfa_method" value="sms">
                            <span class="radio-label">
                                <span class="radio-icon">ğŸ’¬</span>
                                <span class="radio-text">
                                    <strong>SMS</strong>
                                    <small>Receive codes via text message</small>
                                </span>
                            </span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Create Account</span>
                    <span class="btn-loading hidden">Creating Account...</span>
                </button>
            </form>

            <!-- Verification Status (shown after signup) -->
            <div id="verification-status" class="verification-panel hidden">
                <h3>ğŸ“‹ Complete Your Registration</h3>
                <p class="verification-subtitle">Please verify your email and phone to continue</p>

                <div class="verification-items">
                    <div class="verification-item">
                        <span class="status-icon" id="email-verify-status">â³</span>
                        <div class="verification-details">
                            <span class="verification-label">Email Verification</span>
                            <span class="verification-hint" id="email-verify-hint">Check your inbox</span>
                        </div>
                        <button type="button" id="resend-email-btn" class="btn btn-secondary btn-small">
                            Resend
                        </button>
                    </div>
                    <div class="verification-item">
                        <span class="status-icon" id="phone-verify-status">â³</span>
                        <div class="verification-details">
                            <span class="verification-label">Phone Verification</span>
                            <span class="verification-hint" id="phone-verify-hint">Enter code sent to your phone</span>
                        </div>
                        <button type="button" id="resend-phone-btn" class="btn btn-secondary btn-small">
                            Resend
                        </button>
                    </div>
                </div>

                <!-- Phone verification code input -->
                <div class="phone-verify-input">
                    <div class="form-group">
                        <label for="phone-verify-code">Phone Verification Code</label>
                        <div class="code-input-group">
                            <input type="text" id="phone-verify-code"
                                   placeholder="Enter 6-digit code" maxlength="6"
                                   pattern="[0-9]{6}" inputmode="numeric">
                            <button type="button" id="verify-phone-btn" class="btn btn-primary btn-small">
                                Verify
                            </button>
                        </div>
                    </div>
                </div>

                <div id="verification-complete" class="verification-complete hidden">
                    <div class="success-icon">âœ…</div>
                    <h4>Verification Complete!</h4>
                    <p>Your account is now awaiting admin approval. You will receive an email once activated.</p>
                </div>
            </div>

            <div id="signup-result" class="result-container hidden"></div>
        </section>

        <!-- Enroll Tab -->
        <section id="enroll-tab" class="tab-content">
            <form id="enroll-form" class="auth-form">
                <div class="form-group">
                    <label for="enroll-username">Username</label>
                    <input type="text" id="enroll-username" name="username" required
                           placeholder="Enter your username" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="enroll-password">Password</label>
                    <input type="password" id="enroll-password" name="password" required
                           placeholder="Enter your password" autocomplete="current-password">
                </div>

                <!-- MFA Method Selection -->
                <div class="form-group">
                    <label>MFA Method</label>
                    <div class="mfa-method-selector">
                        <label class="radio-option">
                            <input type="radio" name="mfa_method" value="totp" checked>
                            <span class="radio-label">
                                <span class="radio-icon">ğŸ“±</span>
                                <span class="radio-text">
                                    <strong>Authenticator App</strong>
                                    <small>Google Authenticator, Authy, etc.</small>
                                </span>
                            </span>
                        </label>
                        <label class="radio-option" id="sms-option">
                            <input type="radio" name="mfa_method" value="sms">
                            <span class="radio-label">
                                <span class="radio-icon">ğŸ’¬</span>
                                <span class="radio-text">
                                    <strong>SMS</strong>
                                    <small>Receive codes via text message</small>
                                </span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Phone Number (for SMS) -->
                <div class="form-group hidden" id="phone-group">
                    <label for="enroll-phone">Phone Number</label>
                    <input type="tel" id="enroll-phone" name="phone_number"
                           placeholder="+1234567890 (E.164 format)"
                           pattern="\+[1-9]\d{1,14}">
                    <small class="form-hint">
                        Enter phone number with country code (e.g., +1 for US)
                    </small>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Enroll for MFA</span>
                    <span class="btn-loading hidden">Enrolling...</span>
                </button>
            </form>

            <div id="enroll-result" class="result-container hidden">
                <!-- TOTP QR Section -->
                <div id="qr-section" class="qr-section hidden">
                    <h3>Scan QR Code</h3>
                    <p>Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>
                    <div id="qr-code" class="qr-code"></div>
                    <div class="manual-entry">
                        <p>Or manually enter this secret:</p>
                        <code id="secret-code"></code>
                        <button id="copy-secret" class="btn btn-secondary btn-small">Copy Secret</button>
                    </div>
                </div>

                <!-- SMS Enrollment Success -->
                <div id="sms-enroll-section" class="sms-section hidden">
                    <h3>ğŸ“± SMS Verification Setup</h3>
                    <p>A verification code has been sent to <strong id="enrolled-phone"></strong></p>
                    <p class="hint">You can now use SMS codes to log in. Each code expires in 5 minutes.</p>
                </div>
            </div>
        </section>

        <!-- Profile Section (shown when logged in) -->
        <section id="profile-section" class="tab-content hidden">
            <div class="section-header">
                <h2>ğŸ‘¤ My Profile</h2>
            </div>
            <form id="profile-form" class="auth-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="profile-username" readonly class="readonly-input">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="profile-firstname">First Name</label>
                        <input type="text" id="profile-firstname" name="first_name">
                    </div>
                    <div class="form-group">
                        <label for="profile-lastname">Last Name</label>
                        <input type="text" id="profile-lastname" name="last_name">
                    </div>
                </div>

                <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email" name="email">
                    <small id="profile-email-hint" class="form-hint"></small>
                </div>

                <div class="form-group">
                    <label for="profile-phone">Phone Number</label>
                    <div class="phone-input-group">
                        <select id="profile-country-code" name="phone_country_code">
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                            <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                        </select>
                        <input type="tel" id="profile-phone" name="phone_number">
                    </div>
                    <small id="profile-phone-hint" class="form-hint"></small>
                </div>

                <div class="form-group">
                    <label>MFA Method</label>
                    <input type="text" id="profile-mfa" readonly class="readonly-input">
                </div>

                <div class="form-group">
                    <label>Account Status</label>
                    <input type="text" id="profile-status" readonly class="readonly-input">
                </div>

                <div class="form-group">
                    <label>Groups</label>
                    <div id="profile-groups" class="group-badges"></div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">Save Changes</span>
                    <span class="btn-loading hidden">Saving...</span>
                </button>
            </form>
        </section>

        <!-- Admin Users Section -->
        <section id="admin-users-section" class="tab-content hidden">
            <div class="section-header">
                <h2>ğŸ‘¥ User Management</h2>
            </div>

            <div class="admin-controls">
                <div class="search-box">
                    <input type="text" id="users-search" placeholder="Search users..." class="search-input">
                </div>
                <div class="filter-controls">
                    <select id="users-status-filter" class="filter-select">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="complete">Awaiting Approval</option>
                        <option value="active">Active</option>
                        <option value="revoked">Revoked</option>
                    </select>
                    <select id="users-group-filter" class="filter-select">
                        <option value="">All Groups</option>
                    </select>
                    <button type="button" id="users-refresh-btn" class="btn btn-secondary btn-small">
                        ğŸ”„ Refresh
                    </button>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="first_name">Name</th>
                            <th class="sortable" data-sort="username">Username</th>
                            <th class="sortable" data-sort="email">Email</th>
                            <th class="sortable" data-sort="status">Status</th>
                            <th>Groups</th>
                            <th class="sortable" data-sort="created_at">Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="users-loading" class="loading-spinner hidden">Loading...</div>
            <div id="users-empty" class="empty-state hidden">No users found</div>
        </section>

        <!-- Admin Groups Section -->
        <section id="admin-groups-section" class="tab-content hidden">
            <div class="section-header">
                <h2>ğŸ“ Group Management</h2>
                <button type="button" id="create-group-btn" class="btn btn-primary btn-small">
                    + Create Group
                </button>
            </div>

            <div class="admin-controls">
                <div class="search-box">
                    <input type="text" id="groups-search" placeholder="Search groups..." class="search-input">
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table" id="groups-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="name">Name</th>
                            <th>Description</th>
                            <th>Members</th>
                            <th class="sortable" data-sort="created_at">Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="groups-table-body">
                        <!-- Groups will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="groups-loading" class="loading-spinner hidden">Loading...</div>
            <div id="groups-empty" class="empty-state hidden">No groups found</div>
        </section>

        <!-- Status Messages -->
        <div id="status-message" class="status-message hidden"></div>

        <footer>
            <p>ğŸ’¡ Need help? Contact your system administrator.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <!-- Group Create/Edit Modal -->
        <div id="group-modal" class="modal hidden">
            <div class="modal-header">
                <h3 id="group-modal-title">Create Group</h3>
                <button type="button" class="modal-close" data-close-modal>&times;</button>
            </div>
            <form id="group-modal-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="group-name">Group Name</label>
                        <input type="text" id="group-name" required placeholder="Enter group name">
                    </div>
                    <div class="form-group">
                        <label for="group-description">Description</label>
                        <textarea id="group-description" rows="3" placeholder="Enter description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>

        <!-- Approve User Modal (with group selection) -->
        <div id="approve-modal" class="modal hidden">
            <div class="modal-header">
                <h3>Approve User</h3>
                <button type="button" class="modal-close" data-close-modal>&times;</button>
            </div>
            <form id="approve-modal-form">
                <div class="modal-body">
                    <p>Approve user <strong id="approve-user-name"></strong> and assign to groups:</p>
                    <div class="form-group">
                        <label>Select Groups (at least one required)</label>
                        <div id="approve-groups-list" class="checkbox-list">
                            <!-- Groups will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                    <button type="submit" class="btn btn-primary">Approve</button>
                </div>
            </form>
        </div>

        <!-- Group Members Modal -->
        <div id="members-modal" class="modal hidden">
            <div class="modal-header">
                <h3 id="members-modal-title">Group Members</h3>
                <button type="button" class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <div id="members-list" class="members-list">
                    <!-- Members will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-close-modal>Close</button>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirm-modal" class="modal hidden">
            <div class="modal-header">
                <h3 id="confirm-modal-title">Confirm</h3>
                <button type="button" class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                <button type="button" id="confirm-modal-ok" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
