# High availability configuration with 3 replicas
# Note: StatefulSet creates individual PVCs for each replica, so ReadWriteOnce works fine
replicaCount: 3

# Enable replication for HA multi-master setup
replication:
  enabled: true
  retry: 60
  timeout: 30  # Increased from default 1 second to prevent replication failures
  interval: "00:00:00:10"
  starttls: "critical"
  tls_reqcert: "never"
  clusterName: "cluster.local"

# Override default image to use ECR repository
image:
  registry: "${ecr_registry}"
  repository: "${ecr_repository}"
  tag: "${openldap_image_tag}"
  pullPolicy: IfNotPresent

global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: "${storage_class_name}"
  ldapDomain: "${openldap_ldap_domain}"
  existingSecret: "${openldap_secret_name}"
  ldapPort: 389
  sslLdapPort: 636

# Enable TLS with auto-generated certificates for osixia/openldap image
# osixia/openldap uses different environment variable names than Bitnami
# Note: LDAP_ADMIN_PASSWORD and LDAP_CONFIG_PASSWORD are now sourced from the Kubernetes secret
# specified in global.existingSecret
env:
  LDAP_DOMAIN: "${openldap_ldap_domain}"
  # Enable TLS (osixia/openldap will auto-generate certificates if they don't exist)
  LDAP_TLS: "true"
  # Don't enforce TLS (allows both LDAP and LDAPS connections)
  LDAP_TLS_ENFORCE: "false"
  # Don't require client certificates
  LDAP_TLS_VERIFY_CLIENT: "never"
  # Certificate filenames (not full paths) - osixia/openldap expects these in /container/service/slapd/assets/certs/
  # If certificates don't exist, osixia/openldap will auto-generate them
  LDAP_TLS_CRT_FILENAME: "ldap.crt"
  LDAP_TLS_KEY_FILENAME: "ldap.key"
  LDAP_TLS_CA_CRT_FILENAME: "ca.crt"

persistence:
  enabled: true
  accessModes:
    - ReadWriteOnce
  size: 8Gi

service:
  annotations: {}
  externalIPs: []
  type: ClusterIP
  sessionAffinity: None

ltb-passwd:
  enabled: true
  image:
    tag: 5.2.3
  podLabels:
    app: "${app_name}"
  # Allow TLS but don't verify certificates (accept self-signed)
  env:
    LDAPTLS_REQCERT: "allow"
  ingress:
    enabled: true
    ingressClassName: "${ingress_class_name}"
    annotations:
      # Note: load-balancer-name is the AWS ALB name (max 32 chars), while group.name is the Kubernetes group identifier (max 63 chars)
      alb.ingress.kubernetes.io/load-balancer-name: "${alb_load_balancer_name}"
      alb.ingress.kubernetes.io/target-type: "${alb_target_type}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      # Note: scheme and ipAddressType are inherited from IngressClassParams
    path: /
    pathType: Prefix
    hosts:
      - "${ltb_passwd_host}"
  ldap:
    bindPWKey: LDAP_ADMIN_PASSWORD

phpldapadmin:
  enabled: true
  # Allow StartTLS but don't verify certificates (accept self-signed)
  env:
    PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT: "allow"
  podLabels:
    app: "${app_name}"
  ingress:
    enabled: true
    ingressClassName: "${ingress_class_name}"
    annotations:
      alb.ingress.kubernetes.io/load-balancer-name: "${alb_load_balancer_name}"
      alb.ingress.kubernetes.io/target-type: "${alb_target_type}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
    path: /
    pathType: Prefix
    hosts:
      - "${phpldapadmin_host}"
