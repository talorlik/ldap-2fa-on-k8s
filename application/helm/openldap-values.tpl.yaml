# Single replica deployment since we're using one ReadWriteOnce PVC
replicaCount: 3

# Disable replication only if using a single replica setup (replicaCount: 1)
replication:
  enabled: true

# Override default image (chart uses non-existent bitnami/openldap)
image:
  repository: osixia/openldap
  tag: "1.5.0"
  pullPolicy: IfNotPresent

global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: "${storage_class_name}"
  ldapDomain: "${openldap_ldap_domain}"
  adminPassword:  "${openldap_admin_password}"
  configPassword: "${openldap_config_password}"
  ldapPort: 389
  sslLdapPort: 636

# Enable TLS with auto-generated certificates for osixia/openldap image
# osixia/openldap uses different environment variable names than Bitnami
env:
  LDAP_DOMAIN: "${openldap_ldap_domain}"
  LDAP_ADMIN_PASSWORD: "${openldap_admin_password}"
  LDAP_CONFIG_PASSWORD: "${openldap_config_password}"
  # Enable TLS (osixia/openldap will auto-generate certificates if they don't exist)
  LDAP_TLS: "true"
  # Don't enforce TLS (allows both LDAP and LDAPS connections)
  LDAP_TLS_ENFORCE: "false"
  # Don't require client certificates
  LDAP_TLS_VERIFY_CLIENT: "never"
  # Certificate filenames (not full paths) - osixia/openldap expects these in /container/service/slapd/assets/certs/
  # If certificates don't exist, osixia/openldap will auto-generate them
  LDAP_TLS_CRT_FILENAME: "ldap.crt"
  LDAP_TLS_KEY_FILENAME: "ldap.key"
  LDAP_TLS_CA_CRT_FILENAME: "ca.crt"

persistence:
  enabled: true
  accessModes:
    - ReadWriteOnce
  size: 8Gi

service:
  annotations: {}
  externalIPs: []
  type: ClusterIP
  sessionAffinity: None

ltb-passwd:
  enabled: true
  image:
    tag: 5.2.3
  podLabels:
    app: "${app_name}"
  # Allow TLS but don't verify certificates (accept self-signed)
  env:
    LDAPTLS_REQCERT: "allow"
  ingress:
    enabled: true
    ingressClassName: "${ingress_class_name}"
    annotations:
      # IngressGroup - REQUIRED on all Ingresses in the group
      alb.ingress.kubernetes.io/group.name: "${alb_group_name}"
      alb.ingress.kubernetes.io/group.order: "10"  # Leader Ingress (lowest order)
      # Leader Ingress annotations - group-wide ALB configuration
      # These are treated as group-wide when building the ALB
      # Note: load-balancer-name is the AWS ALB name (max 32 chars), while group.name is the Kubernetes group identifier (max 63 chars)
      alb.ingress.kubernetes.io/load-balancer-name: "${alb_load_balancer_name}"
      alb.ingress.kubernetes.io/target-type: "${alb_target_type}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
      alb.ingress.kubernetes.io/certificate-arn: "${acm_cert_arn}"
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/ssl-policy: "${alb_ssl_policy}"
      # Note: scheme and ipAddressType are inherited from IngressClassParams
    path: /
    pathType: Prefix
    hosts:
      - "${ltb_passwd_host}"
  ldap:
    bindPWKey: LDAP_ADMIN_PASSWORD

phpldapadmin:
  enabled: true
  # Allow StartTLS but don't verify certificates (accept self-signed)
  env:
    PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT: "allow"
  podLabels:
    app: "${app_name}"
  ingress:
    enabled: true
    ingressClassName: "${ingress_class_name}"
    annotations:
      # IngressGroup - REQUIRED on all Ingresses in the group
      alb.ingress.kubernetes.io/group.name: "${alb_group_name}"
      alb.ingress.kubernetes.io/group.order: "20"  # Secondary Ingress
      # Note: Group-wide ALB settings (listen-ports, certificate-arn, ssl-redirect, etc.)
      # are inherited from the leader Ingress (order 10). Only group.name and group.order
      # are required on secondary Ingresses.
    path: /
    pathType: Prefix
    hosts:
      - "${phpldapadmin_host}"
