name: Backend Infra Provisioning

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Select AWS Region'
        required: true
        type: choice
        default: 'us-east-1: N. Virginia'
        options:
          - 'us-east-1: N. Virginia'
          - 'us-east-2: Ohio'
      environment:
        description: 'Select Environment'
        required: true
        type: choice
        default: prod
        options:
          - prod
          - dev

jobs:
  SetRegion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      region_code: ${{ steps.set_region.outputs.region_code }}
    steps:
      - name: Set Region
        id: set_region
        run: |
          SELECTED_REGION="${{ inputs.region }}"
          echo "region_code=${SELECTED_REGION%%:*}" >> $GITHUB_OUTPUT

  InfraProvision:
    runs-on: ubuntu-latest
    needs:
      - SetRegion
    permissions:
      contents: write
      actions: write
      id-token: write
    env:
      AWS_REGION: ${{ needs.SetRegion.outputs.region_code }}
    defaults:
      run:
        working-directory: ./backend_infra
    steps:
      - name: Checkout the repo code
        uses: actions/checkout@v4

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Configure AWS credentials (State Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STATE_ACCOUNT_ROLE_ARN }}
          role-session-name: GitHubActions-BackendInfraProvision
          aws-region: ${{ env.AWS_REGION }}

      - name: Create backend.hcl from placeholder
        run: |
          cp tfstate-backend-values-template.hcl backend.hcl
          sed -i -e "s|<BACKEND_BUCKET_NAME>|${{ vars.BACKEND_BUCKET_NAME }}|g" \
          -e "s|<BACKEND_PREFIX>|${{ vars.BACKEND_PREFIX }}|g" \
          -e "s|<AWS_REGION>|${{ env.AWS_REGION }}|g" \
          backend.hcl
          echo "Created backend.hcl:"
          cat backend.hcl

      - name: Update variables.tfvars
        run: |
          sed -i "s|^env[[:space:]]*=.*|env = \"${{ inputs.environment }}\"|" variables.tfvars
          sed -i "s|^region[[:space:]]*=.*|region = \"${{ env.AWS_REGION }}\"|" variables.tfvars
          # Set deployment account role ARN based on environment
          DEPLOYMENT_ROLE_ARN="${{ inputs.environment == 'prod' && secrets.AWS_PRODUCTION_ACCOUNT_ROLE_ARN || secrets.AWS_DEVELOPMENT_ACCOUNT_ROLE_ARN }}"
          if ! grep -q "^deployment_account_role_arn" variables.tfvars; then
            echo "deployment_account_role_arn = \"${DEPLOYMENT_ROLE_ARN}\"" >> variables.tfvars
          else
            sed -i "s|^deployment_account_role_arn[[:space:]]*=.*|deployment_account_role_arn = \"${DEPLOYMENT_ROLE_ARN}\"|" variables.tfvars
          fi
          # Set ExternalId for cross-account role assumption security
          EXTERNAL_ID="${{ secrets.AWS_ASSUME_EXTERNAL_ID }}"
          if ! grep -q "^deployment_account_external_id" variables.tfvars; then
            echo "deployment_account_external_id = \"${EXTERNAL_ID}\"" >> variables.tfvars
          else
            sed -i "s|^deployment_account_external_id[[:space:]]*=.*|deployment_account_external_id = \"${EXTERNAL_ID}\"|" variables.tfvars
          fi
          echo "Updated variables.tfvars:"
          cat variables.tfvars

      - name: Terraform init
        run: terraform init -backend-config=backend.hcl

      - name: Terraform workspace
        run: |
          WORKSPACE="${{ env.AWS_REGION }}-${{ inputs.environment }}"
          terraform workspace select $WORKSPACE || terraform workspace new $WORKSPACE

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan
        run: terraform plan -var-file="variables.tfvars" -out terraform.tfplan

      - name: Provision backend infrastructure
        id: provision_backend
        run: |
          terraform apply -auto-approve terraform.tfplan
          ECR_REPOSITORY_NAME=$(terraform output -raw ecr_repository)
          echo "ecr_repository_name=$ECR_REPOSITORY_NAME" >> $GITHUB_OUTPUT

      - name: Save ECR repository name to GitHub repository variable
        uses: actions/github-script@v7
        env:
          ECR_REPOSITORY_NAME: ${{ steps.provision_backend.outputs.ecr_repository_name }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const ecrRepositoryName = process.env.ECR_REPOSITORY_NAME;
            const repo = context.repo;

            if (!ecrRepositoryName || ecrRepositoryName.trim() === '') {
              throw new Error('ECR_REPOSITORY_NAME is not set or is empty');
            }

            console.log(`Saving ECR repository name: ${ecrRepositoryName}`);

            try {
              // Try to get existing ECR repository name variable
              try {
                await github.rest.actions.getRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'ECR_REPOSITORY_NAME'
                });

                // Update existing ECR repository name variable
                await github.rest.actions.updateRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'ECR_REPOSITORY_NAME',
                  value: ecrRepositoryName
                });
                console.log('Updated repository variable ECR_REPOSITORY_NAME');
              } catch (error) {
                if (error.status === 404) {
                  // Variable doesn't exist, create it
                  await github.rest.actions.createRepoVariable({
                    owner: repo.owner,
                    repo: repo.repo,
                    name: 'ECR_REPOSITORY_NAME',
                    value: ecrRepositoryName
                  });
                  console.log('Created repository variable ECR_REPOSITORY_NAME');
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error saving ECR repository name variable:', error.message);
              throw error;
            }
