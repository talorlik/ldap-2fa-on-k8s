name: TF Backend State Provisioning

on:
  workflow_dispatch:

jobs:
  InfraProvision:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ vars.AWS_REGION }}
    defaults:
      run:
        working-directory: ./tf_backend_state
    steps:
      - name: Checkout the repo code
        uses: actions/checkout@v2

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check for existing state file
        uses: actions/github-script@v7
        id: check_state
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const repo = context.repo;
            let bucketName = null;

            try {
              // Try to get existing BACKEND_BUCKET_NAME variable
              const response = await github.rest.actions.getRepoVariable({
                owner: repo.owner,
                repo: repo.repo,
                name: 'BACKEND_BUCKET_NAME'
              });
              bucketName = response.data.value;
              console.log(`Found existing BACKEND_BUCKET_NAME: ${bucketName}`);
              core.setOutput('bucket_name', bucketName);
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                console.log('BACKEND_BUCKET_NAME variable does not exist, proceeding with new provisioning');
                core.setOutput('exists', 'false');
              } else {
                console.error('Error checking repository variable:', error.message);
                throw error;
              }
            }

      - name: Download existing state file if available
        if: steps.check_state.outputs.exists == 'true'
        env:
          BUCKET_NAME: ${{ steps.check_state.outputs.bucket_name }}
          BACKEND_PREFIX: ${{ vars.BACKEND_PREFIX }}
        run: |
          if [ -z "$BUCKET_NAME" ] || [ -z "$BACKEND_PREFIX" ]; then
            echo "Bucket name or prefix is empty, skipping state file download"
            exit 0
          fi

          S3_PATH="s3://${BUCKET_NAME}/${BACKEND_PREFIX}"
          echo "Attempting to download state file from: ${S3_PATH}"

          if aws s3 ls "$S3_PATH" > /dev/null 2>&1; then
            echo "State file exists, downloading..."
            aws s3 cp "$S3_PATH" terraform.tfstate
            echo "State file downloaded successfully"
          else
            echo "State file does not exist in S3, proceeding with new provisioning"
          fi

      - name: Terraform init
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan
        run: terraform plan -var-file="variables.tfvars" -out terraform.tfplan

      - name: Provision backend state
        run: |
          terraform apply -auto-approve terraform.tfplan
          echo "BACKEND_BUCKET_NAME=$(terraform output -raw bucket_name)" >> $GITHUB_ENV

      - name: Save bucket name to GitHub repository variable
        uses: actions/github-script@v7
        env:
          BUCKET_NAME: ${{ env.BACKEND_BUCKET_NAME }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const bucketName = process.env.BUCKET_NAME;
            const repo = context.repo;

            if (!bucketName) {
              throw new Error('BUCKET_NAME environment variable is not set');
            }

            console.log(`Saving bucket name: ${bucketName}`);

            try {
              // Try to get existing bucket name variable
              try {
                await github.rest.actions.getRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_BUCKET_NAME'
                });

                // Update existing bucket name variable
                await github.rest.actions.updateRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_BUCKET_NAME',
                  value: bucketName
                });
                console.log('Updated repository variable BACKEND_BUCKET_NAME');
              } catch (error) {
                if (error.status === 404) {
                  // Variable doesn't exist, create it
                  await github.rest.actions.createRepoVariable({
                    owner: repo.owner,
                    repo: repo.repo,
                    name: 'BACKEND_BUCKET_NAME',
                    value: bucketName
                  });
                  console.log('Created repository variable BACKEND_BUCKET_NAME');
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error saving repository variable:', error.message);
              console.error('Note: GITHUB_TOKEN may need write permissions for repository variables.');
              console.error('Please ensure "Allow GitHub Actions to create and approve pull requests" is enabled in repository settings.');
              throw error;
            }

      - name: Upload backend state file to S3
        run: |
          aws s3 cp terraform.tfstate s3://${{ env.BACKEND_BUCKET_NAME }}/${{ vars.BACKEND_PREFIX }}