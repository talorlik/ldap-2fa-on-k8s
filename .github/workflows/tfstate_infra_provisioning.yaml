name: TF Backend State Provisioning

on:
  workflow_dispatch:

jobs:
  InfraProvision:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ vars.AWS_REGION }}
    defaults:
      run:
        working-directory: ./tf_backend_state
    steps:
      - name: Checkout the repo code
        uses: actions/checkout@v2

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan
        run: terraform plan -var-file="variables.tfvars" -out terraform.tfplan

      - name: Provision backend state
        run: |
          terraform apply -auto-approve terraform.tfplan
          echo "BACKEND_BUCKET_NAME=$(terraform output -raw bucket_name)" >> $GITHUB_ENV
          echo "BACKEND_DYNAMODB_TABLE_NAME=$(terraform output -raw dynamodb_table_name)" >> $GITHUB_ENV

      - name: Save bucket name to GitHub repository variable
        uses: actions/github-script@v7
        env:
          BUCKET_NAME: ${{ env.BACKEND_BUCKET_NAME }}
          TABLE_NAME: ${{ env.BACKEND_DYNAMODB_TABLE_NAME }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const bucketName = process.env.BUCKET_NAME;
            const tableName = process.env.TABLE_NAME;
            const repo = context.repo;

            if (!bucketName) {
              throw new Error('BUCKET_NAME environment variable is not set');
            }

            if (!tableName) {
              throw new Error('TABLE_NAME environment variable is not set');
            }

            console.log(`Saving bucket name: ${bucketName}`);
            console.log(`Saving table name: ${tableName}`);

            try {
              // Try to get existing bucket name variable
              try {
                await github.rest.actions.getRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_BUCKET_NAME'
                });

                // Update existing bucket name variable
                await github.rest.actions.updateRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_BUCKET_NAME',
                  value: bucketName
                });
                console.log('Updated repository variable BACKEND_BUCKET_NAME');
              } catch (error) {
                if (error.status === 404) {
                  // Variable doesn't exist, create it
                  await github.rest.actions.createRepoVariable({
                    owner: repo.owner,
                    repo: repo.repo,
                    name: 'BACKEND_BUCKET_NAME',
                    value: bucketName
                  });
                  console.log('Created repository variable BACKEND_BUCKET_NAME');
                } else {
                  throw error;
                }
              }
              // Try to get existing table name variable
              try {
                await github.rest.actions.getRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_DYNAMODB_TABLE_NAME'
                });

                // Update existing variable
                await github.rest.actions.updateRepoVariable({
                  owner: repo.owner,
                  repo: repo.repo,
                  name: 'BACKEND_DYNAMODB_TABLE_NAME',
                  value: tableName
                });
                console.log('Updated repository variable BACKEND_DYNAMODB_TABLE_NAME');
              } catch (error) {
                if (error.status === 404) {
                  // Variable doesn't exist, create it
                  await github.rest.actions.createRepoVariable({
                    owner: repo.owner,
                    repo: repo.repo,
                    name: 'BACKEND_DYNAMODB_TABLE_NAME',
                    value: tableName
                  });
                  console.log('Created repository variable BACKEND_DYNAMODB_TABLE_NAME');
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error saving repository variable:', error.message);
              console.error('Note: GITHUB_TOKEN may need write permissions for repository variables.');
              console.error('Please ensure "Allow GitHub Actions to create and approve pull requests" is enabled in repository settings.');
              throw error;
            }

      - name: Upload backend state file to S3
        run: |
          aws s3 cp terraform.tfstate s3://${{ env.BACKEND_BUCKET_NAME }}${{ vars.BACKEND_PREFIX }}