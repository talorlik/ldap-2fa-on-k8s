name: Application Infra Provisioning

# Required GitHub Repository Secrets:
# - AWS_STATE_ACCOUNT_ROLE_ARN: IAM role ARN for backend state operations
# - AWS_PRODUCTION_ACCOUNT_ROLE_ARN: IAM role ARN for production deployments
# - AWS_DEVELOPMENT_ACCOUNT_ROLE_ARN: IAM role ARN for development deployments
# - AWS_ASSUME_EXTERNAL_ID: ExternalId for cross-account role assumption security
# - TF_VAR_OPENLDAP_ADMIN_PASSWORD: OpenLDAP admin password
# - TF_VAR_OPENLDAP_CONFIG_PASSWORD: OpenLDAP config password
# - TF_VAR_POSTGRESQL_PASSWORD: PostgreSQL database password
# - TF_VAR_REDIS_PASSWORD: Redis password for SMS OTP storage
#
# Note: GitHub workflows use repository secrets, while bash scripts use AWS Secrets Manager.
# The secrets listed above must be configured in GitHub repository settings.

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Select AWS Region'
        required: true
        type: choice
        default: 'us-east-1: N. Virginia'
        options:
          - 'us-east-1: N. Virginia'
          - 'us-east-2: Ohio'
      environment:
        description: 'Select Environment'
        required: true
        type: choice
        default: prod
        options:
          - prod
          - dev

jobs:
  SetRegion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      region_code: ${{ steps.set_region.outputs.region_code }}
    steps:
      - name: Set Region
        id: set_region
        run: |
          SELECTED_REGION="${{ inputs.region }}"
          echo "region_code=${SELECTED_REGION%%:*}" >> $GITHUB_OUTPUT

  InfraProvision:
    runs-on: ubuntu-latest
    needs:
      - SetRegion
    permissions:
      contents: write
      actions: write
      id-token: write
    env:
      AWS_REGION: ${{ needs.SetRegion.outputs.region_code }}
      # Note: TF_VAR environment variables are case-sensitive and must match variable names in variables.tf
      # Secrets in GitHub remain uppercase, but environment variables must be lowercase
      TF_VAR_openldap_admin_password: ${{ secrets.TF_VAR_OPENLDAP_ADMIN_PASSWORD }}
      TF_VAR_openldap_config_password: ${{ secrets.TF_VAR_OPENLDAP_CONFIG_PASSWORD }}
      # Redis password for SMS OTP storage
      TF_VAR_redis_password: ${{ secrets.TF_VAR_REDIS_PASSWORD }}
      # PostgreSQL password for User management database
      TF_VAR_postgresql_database_password: ${{ secrets.TF_VAR_POSTGRESQL_PASSWORD }}
    defaults:
      run:
        working-directory: ./application
    steps:
      - name: Checkout the repo code
        uses: actions/checkout@v4

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Configure AWS credentials (State Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STATE_ACCOUNT_ROLE_ARN }}
          role-session-name: GitHubActions-ApplicationInfraProvision
          aws-region: ${{ env.AWS_REGION }}

      - name: Create backend.hcl from placeholder
        run: |
          cp tfstate-backend-values-template.hcl backend.hcl
          sed -i -e "s|<BACKEND_BUCKET_NAME>|${{ vars.BACKEND_BUCKET_NAME }}|g" \
          -e "s|<APPLICATION_PREFIX>|${{ vars.APPLICATION_PREFIX }}|g" \
          -e "s|<AWS_REGION>|${{ env.AWS_REGION }}|g" \
          backend.hcl
          echo "Created backend.hcl:"
          cat backend.hcl

      - name: Update variables.tfvars
        run: |
          sed -i "s|^env[[:space:]]*=.*|env = \"${{ inputs.environment }}\"|" variables.tfvars
          sed -i "s|^region[[:space:]]*=.*|region = \"${{ env.AWS_REGION }}\"|" variables.tfvars
          # Set deployment account role ARN based on environment
          DEPLOYMENT_ROLE_ARN="${{ inputs.environment == 'prod' && secrets.AWS_PRODUCTION_ACCOUNT_ROLE_ARN || secrets.AWS_DEVELOPMENT_ACCOUNT_ROLE_ARN }}"
          if ! grep -q "^deployment_account_role_arn" variables.tfvars; then
            echo "deployment_account_role_arn = \"${DEPLOYMENT_ROLE_ARN}\"" >> variables.tfvars
          else
            sed -i "s|^deployment_account_role_arn[[:space:]]*=.*|deployment_account_role_arn = \"${DEPLOYMENT_ROLE_ARN}\"|" variables.tfvars
          fi
          # Set ExternalId for cross-account role assumption security
          EXTERNAL_ID="${{ secrets.AWS_ASSUME_EXTERNAL_ID }}"
          if ! grep -q "^deployment_account_external_id" variables.tfvars; then
            echo "deployment_account_external_id = \"${EXTERNAL_ID}\"" >> variables.tfvars
          else
            sed -i "s|^deployment_account_external_id[[:space:]]*=.*|deployment_account_external_id = \"${EXTERNAL_ID}\"|" variables.tfvars
          fi
          echo "Updated variables.tfvars:"
          cat variables.tfvars

      - name: Terraform init
        run: terraform init -backend-config=backend.hcl

      - name: Terraform workspace
        run: |
          WORKSPACE="${{ env.AWS_REGION }}-${{ inputs.environment }}"
          terraform workspace select $WORKSPACE || terraform workspace new $WORKSPACE

      - name: Terraform validate
        run: terraform validate

      - name: Set Kubernetes environment variables
        run: |
          chmod +x ./set-k8s-env.sh
          source ./set-k8s-env.sh
          echo "KUBERNETES_MASTER=$KUBERNETES_MASTER" >> $GITHUB_ENV
          echo "KUBE_CONFIG_PATH=$KUBE_CONFIG_PATH" >> $GITHUB_ENV

      - name: Terraform plan
        run: terraform plan -var-file="variables.tfvars" -out terraform.tfplan

      - name: Provision application infrastructure
        run: terraform apply -auto-approve terraform.tfplan
